<!DOCTYPE html>
<html lang="nl">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Upgrade</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.0/dist/themes/light.css">
	<script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.0/cdn/shoelace.js"></script>
	<style>
		body {
			font-family: sans-serif;
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
		}
		h1 {
			color: #333;
			margin-bottom: 20px;
		}
		h2 {
			color: #333;
			margin-bottom: 5px;
		}
		p {
			margin-top: 0;
			margin-bottom: 15px;
			color: #666;
		}
		.form-section {
			margin-bottom: 25px;
		}
		.form-section h2 {
			margin-bottom: 15px;
			font-size: 1rem;
			color: #444;
		}
		.form-section-header {
			margin-bottom: 15px;
			font-size: 1.2rem;
			color: #444;
		}
		.option-group {
			margin-bottom: 15px;
		}
		.option-group label {
			display: block;
			margin-bottom: 8px;
		}
		.result-table {
			width: 60%;
			border-collapse: collapse;
			margin-top: 30px;
		}
		.result-table th,
		.result-table td {
			border: 1px solid #ddd;
			padding: 8px;
			text-align: left;
		}
		.result-table th {
			background-color: #f2f2f2;
		}
		.result-section {
			margin-top: 40px;
			display: none;
		}
		.price {
			text-align: right;
		}
		.totals {
			font-weight: bold;
		}
		.subtotal {
			border-top: 2px solid #333;
		}
		.bundle-info {
			margin-top: 20px;
		}
		.bundles-container {
			display: flex;
			gap: 15px;
			margin-bottom: 30px;
			flex-wrap: wrap;
		}
		.bundle-box {
			border: 2px solid #ddd;
			border-radius: 8px;
			padding: 15px;
			width: 211px; /* Reduced by 10% from 234px (rounded to nearest pixel) */
			cursor: pointer;
			transition: all 0.3s ease;
			background-color: #f9f9f9;
			display: flex;
			flex-direction: column;
			height: 144px; /* Reduced by 10% from 160px (rounded to nearest pixel) */
		}
		.bundle-box:hover {
			border-color: #0077cc;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		}
		.bundle-box.active {
			border-color: #0077cc;
			background-color: #f0f7ff;
		}
		.bundle-box h3 {
			margin-top: 0;
			margin-bottom: 10px;
			color: #333;
			font-size: 1rem;
		}
		.bundle-box ul {
			margin: 0;
			padding-left: 20px;
			color: #555;
			flex-grow: 1;
			font-size: 0.9em;
		}
		.bundle-footer {
			margin-top: 10px;
			display: flex;
			flex-direction: column;
			align-items: flex-start;
		}
		.bundle-footer p {
			margin: 0;
			font-weight: bold;
			color: #0077cc;
		}
		@media (max-width: 768px) {
			.bundles-container {
				justify-content: center;
			}
			.result-table {
				width: 100%;
			}
		}
	</style>
</head>

<body>
	<h1 id="mainTitle">Upgrade</h1>
	<p id="mainSubtitle">Kies een reeds afgenomen pakket of stel zelf samen</p>

	<div class="bundles-container">
		<div class="bundle-box" id="bundle1">
			<h3>Pakket</h3>
			<ul id="bundle1Items">
				<li>Laden...</li>
			</ul>
			<div class="bundle-footer">
				<p id="bundle1Price">€ 0,00</p>
			</div>
		</div>

		<div class="bundle-box" id="bundle2">
			<h3>Pakket</h3>
			<ul id="bundle2Items">
				<li>Laden...</li>
			</ul>
			<div class="bundle-footer">
				<p id="bundle2Price">€ 0,00</p>
			</div>
		</div>

		<div class="bundle-box" id="bundle3">
			<h3>Pakket</h3>
			<ul id="bundle3Items">
				<li>Laden...</li>
			</ul>
			<div class="bundle-footer">
				<p id="bundle3Price">€ 0,00</p>
			</div>
		</div>

		<div class="bundle-box" id="customBundle">
			<h3>Zelf samenstellen</h3>
			<ul id="customBundleItems">
				<li>Kies je eigen combinatie</li>
			</ul>
			<div class="bundle-footer">
				<p>&nbsp;</p>
			</div>
		</div>
	</div>

	<div id="ism3Form" style="display: none;">
		<h2 class="form-section-header" style="margin-top: 10px; margin-bottom: 20px;">Upgradeformulier</h2>
		<div class="form-section">
			<h2>Klanttoegang tot Boekhouding</h2>
			<div class="option-group">
				<label>
					<input type="radio" name="boekhouding" value="geen"> Nee, graag geen enkele toegang tot Financieel
				</label>
				<label>
					<input type="radio" name="boekhouding" value="financieel"> Financieel
				</label>
				<label>
					<input type="radio" name="boekhouding" value="financieel-meekijken"> Financieel alleen Meekijken
				</label>
			</div>
		</div>

		<div class="form-section">
			<h2>Verkoopfacturen</h2>
			<div class="option-group">
				<label>
					<input type="checkbox" name="facturatie"> Facturatie
				</label>
			</div>
		</div>

		<div class="form-section">
			<h2>Documenten</h2>
			<div class="option-group">
				<label>
					<input type="radio" name="documenten" value="nvt"> Geen AdmInbox
				</label>
				<label>
					<input type="radio" name="documenten" value="adminbox-scanuser"> AdmInbox (Alleen Aanleveren)
				</label>
				<label>
					<input type="radio" name="documenten" value="adminbox"> AdmInbox (Aanleveren & Registreren)
				</label>
			</div>
		</div>

		<div class="form-section">
			<h2>Facturen en bonnetjes herkennen</h2>
			<div class="option-group">
				<label>
					<input type="checkbox" name="ocr"> OCR
				</label>
			</div>
		</div>
	</div>

	<div id="resultSection" class="result-section">
		<h2 class="form-section-header">Kostenoverzicht</h2>
		<table id="resultTable" class="result-table">
			<thead>
				<tr>
					<th>Omschrijving</th>
					<th style="text-align: right;">Bedrag</th>
				</tr>
			</thead>
			<tbody id="resultTableBody">
			</tbody>
		</table>
		<div id="bundleInfo" class="bundle-info"></div>
	</div>

	<script>
		let prices = [];
		let bundles = [];
		let componentNames = [];
		let componentMap = {};

		function xorDecrypt(encodedText, key) {
			try {
				encodedText = encodedText.replace(/-/g, '+').replace(/_/g, '/');
				while (encodedText.length % 4) encodedText += '=';
				let decoded = atob(encodedText);
				let result = '';
				for (let i = 0; i < decoded.length; i++) {
					const charCode = decoded.charCodeAt(i) ^ key.charCodeAt(i % key.length);
					result += String.fromCharCode(charCode);
				}
				return result;
			} catch (e) {
				console.error('Decryption error:', e);
				return '';
			}
		}

		function processURLParameters() {
			const urlParams = new URLSearchParams(window.location.search);
			
			// Check for direct parameters first (from the demo.html link)
			if (urlParams.has('title')) {
				try {
					// Get direct parameters
					const data = {
						title: urlParams.get('title'),
						subtitle: urlParams.get('subtitle'),
						removeAdminCounts: urlParams.get('removeAdminCounts') === 'true',
						enableCommunication: urlParams.get('enableCommunication') === 'true'
					};
					
					// Parse JSON parameters
					if (urlParams.has('ps')) {
						data.ps = JSON.parse(decodeURIComponent(urlParams.get('ps')));
					}
					
					if (urlParams.has('cn')) {
						data.cn = JSON.parse(decodeURIComponent(urlParams.get('cn')));
					}
					
					if (urlParams.has('bs')) {
						data.bs = JSON.parse(decodeURIComponent(urlParams.get('bs')));
					}
					
					if (urlParams.has('ui')) {
						data.ui = JSON.parse(decodeURIComponent(urlParams.get('ui')));
					}
					
					loadAppData(data);
				} catch (e) {
					console.error('Error processing direct parameters:', e);
				}
			}
			// Check for encrypted data as fallback
			else if (urlParams.has('data') && urlParams.has('key')) {
				try {
					const encryptedData = urlParams.get('data');
					const key = urlParams.get('key');
					
					const decryptedData = xorDecrypt(encryptedData, key);
					const data = JSON.parse(decryptedData);
					
					loadAppData(data);
				} catch (e) {
					console.error('Error processing encrypted data:', e);
				}
			}
		}
		
		function loadAppData(data) {
			if (data.title) {
				document.getElementById('mainTitle').textContent = data.title;
				document.title = data.title;
			}
			
			if (data.subtitle) {
				document.getElementById('mainSubtitle').textContent = data.subtitle;
			}
			
			if (data.ps) {
				setupPrices(data.ps);
			}
			
			if (data.cn) {
				setupComponentNames(data.cn);
			}
			
			if (data.bs) {
				setupBundles(data.bs);
			}
			
			if (data.ui) {
				setupUI(data.ui);
			}
			
			initializeApp();
		}
		
		function setupPrices(pricesArray) {
			prices = pricesArray;
			
			componentMap = {
				0: 'a',
				1: 'b',
				2: 'c',
				3: 'd',
				4: 'e',
				5: 'f'
			};
		}
		
		function setupComponentNames(namesArray) {
			componentNames = namesArray;
		}
		
		function setupBundles(bundlesData) {
			bundles = bundlesData.map(b => {
				return {
					components: b.c.map(index => componentMap[index]),
					discount: b.d,
					code: b.n
				};
			});
		}
		
		function setupUI(uiData) {
			if (uiData.length >= 4) {
				setupBundleUI('bundle1', uiData[0]);
				setupBundleUI('bundle2', uiData[1]);
				setupBundleUI('bundle3', uiData[2]);
				setupBundleUI('customBundle', uiData[3]);
			}
		}
		
		function setupBundleUI(bundleId, data) {
			if (!data) return;
			
			const itemsElement = document.getElementById(bundleId + 'Items');
			const priceElement = document.getElementById(bundleId + 'Price');
			
			if (itemsElement && data.i && data.i.length > 0) {
				itemsElement.innerHTML = '';
				
				const items = data.i.map(item => {
					if (typeof item === 'number' && componentNames[item]) {
						return componentNames[item];
					}
					return item;
				});
				
				items.forEach(item => {
					const li = document.createElement('li');
					if (typeof item === 'string' && item.includes('(')) {
						// Make text between parentheses (including parentheses) italic
						// and insert a line break after opening parenthesis
						li.innerHTML = item.replace(/(\([^)]+\))/g, function(match) {
							return '<i>' + match.replace(/\(/g, '(<br>') + '</i>';
						});
					} else {
						li.textContent = item;
					}
					itemsElement.appendChild(li);
				});
			}
			
			if (priceElement && data.p) {
				priceElement.textContent = data.p;
			}
		}
		
		function fillForm(components) {
			document.querySelector('input[name="boekhouding"][value="geen"]').checked = true;
			document.querySelector('input[name="facturatie"]').checked = false;
			document.querySelector('input[name="documenten"][value="nvt"]').checked = true;
			document.querySelector('input[name="ocr"]').checked = false;

			if (components.includes('a')) {
				document.querySelector('input[name="boekhouding"][value="financieel"]').checked = true;
			} else if (components.includes('b')) {
				document.querySelector('input[name="boekhouding"][value="financieel-meekijken"]').checked = true;
			}

			if (components.includes('c')) {
				document.querySelector('input[name="facturatie"]').checked = true;
			}

			if (components.includes('d')) {
				document.querySelector('input[name="documenten"][value="adminbox"]').checked = true;
			} else if (components.includes('e')) {
				document.querySelector('input[name="documenten"][value="adminbox-scanuser"]').checked = true;
			}

			if (components.includes('f')) {
				document.querySelector('input[name="ocr"]').checked = true;
			}
		}
		
		function highlightActiveBundle(bundleId) {
			document.querySelectorAll('.bundle-box').forEach(box => {
				box.classList.remove('active');
			});
			document.getElementById(bundleId).classList.add('active');
		}
		
		function getSelectedComponents() {
			const boekhoudingChecked = document.querySelector('input[name="boekhouding"]:checked');
			const documentenChecked = document.querySelector('input[name="documenten"]:checked');

			const boekhouding = boekhoudingChecked ? boekhoudingChecked.value : '';
			const facturatie = document.querySelector('input[name="facturatie"]').checked;
			const documenten = documentenChecked ? documentenChecked.value : '';
			const ocrChecked = document.querySelector('input[name="ocr"]').checked;

			const selectedComponents = [];

			if (boekhouding === 'financieel') {
				selectedComponents.push('a');
			} else if (boekhouding === 'financieel-meekijken') {
				selectedComponents.push('b');
			}

			if (facturatie) {
				selectedComponents.push('c');
			}

			if (documenten === 'adminbox') {
				selectedComponents.push('d');
			} else if (documenten === 'adminbox-scanuser') {
				selectedComponents.push('e');
			}

			return {
				selectedComponents,
				ocrChecked
			};
		}
		
		function updateBundleHighlighting(components) {
			if (!document.getElementById('customBundle').classList.contains('active')) {
				const sortedComponents = [...components].sort();
				const selectedStr = JSON.stringify(sortedComponents);

				if (JSON.stringify(['a', 'c', 'd'].sort()) === selectedStr) {
					highlightActiveBundle('bundle1');
				} else if (JSON.stringify(['b', 'd'].sort()) === selectedStr) {
					highlightActiveBundle('bundle2');
				} else if (JSON.stringify(['a', 'c'].sort()) === selectedStr) {
					highlightActiveBundle('bundle3');
				} else {
					highlightActiveBundle('customBundle');
				}
			}
		}
		
		function calculatePrices() {
			const { selectedComponents, ocrChecked } = getSelectedComponents();
			const sortedComponents = [...selectedComponents].sort();

			let bundleMatch = null;
			for (const bundle of bundles) {
				const sortedBundleComponents = [...bundle.components].sort();
				if (JSON.stringify(sortedComponents) === JSON.stringify(sortedBundleComponents)) {
					bundleMatch = bundle;
					break;
				}
			}

			let subtotal = 0;
			for (const component of selectedComponents) {
				const componentIndex = Object.keys(componentMap).find(key => componentMap[key] === component);
				if (componentIndex !== undefined) {
					subtotal += prices[componentIndex];
				}
			}

			const discount = bundleMatch ? bundleMatch.discount : 0;
			const bundleTotal = subtotal - discount;

			const ocrCost = ocrChecked ? prices[5] : 0; // OCR is at index 5

			const total = bundleTotal + ocrCost;

			displayResults(selectedComponents, subtotal, discount, bundleTotal, ocrChecked, ocrCost, total, bundleMatch);

			updateBundleHighlighting(selectedComponents);
			
			sendDataToParent(selectedComponents, total, bundleMatch);
		}
        
        function sendDataToParent(components, total, bundle) {
            if (window.parent && window.parent !== window) {
                const selectedData = {
                    components: components,
                    total: total,
                    bundleCode: bundle ? bundle.code : null
                };
                
                try {
                    window.parent.postMessage({
                        type: 'selection',
                        data: selectedData
                    }, '*');
                } catch (e) {
                    console.error('Fout bij verzenden data naar parent:', e);
                }
            }
        }

		function displayResults(components, subtotal, discount, bundleTotal, ocrChecked, ocrCost, total, bundle) {
			const resultSection = document.getElementById('resultSection');
			const resultTableBody = document.getElementById('resultTableBody');
			const bundleInfo = document.getElementById('bundleInfo');

			resultTableBody.innerHTML = '';
			bundleInfo.innerHTML = '';

			if ((components.length > 0 || ocrChecked) && total > 0) {
				resultSection.style.display = 'block';

				for (const component of components) {
					const row = document.createElement('tr');
					const componentIndex = Object.keys(componentMap).find(key => componentMap[key] === component);

					const nameCell = document.createElement('td');
					nameCell.textContent = componentNames[componentIndex];

					const priceCell = document.createElement('td');
					priceCell.textContent = '€ ' + prices[componentIndex].toFixed(2).replace('.', ',');
					priceCell.style.textAlign = 'right';

					row.appendChild(nameCell);
					row.appendChild(priceCell);

					resultTableBody.appendChild(row);
				}

				if (discount > 0) {
					const discountRow = document.createElement('tr');

					const discountNameCell = document.createElement('td');
					discountNameCell.textContent = 'Bundelkorting';

					const discountPriceCell = document.createElement('td');
					discountPriceCell.textContent = '€ -' + discount.toFixed(2).replace('.', ',');
					discountPriceCell.style.textAlign = 'right';

					discountRow.appendChild(discountNameCell);
					discountRow.appendChild(discountPriceCell);

					resultTableBody.appendChild(discountRow);
				}

				if (bundleTotal !== total || ocrChecked) {
					const bundleRow = document.createElement('tr');
					bundleRow.className = 'subtotal';

					const bundleNameCell = document.createElement('td');
					bundleNameCell.textContent = 'Bundle';

					const bundlePriceCell = document.createElement('td');
					bundlePriceCell.textContent = '€ ' + bundleTotal.toFixed(2).replace('.', ',');
					bundlePriceCell.style.textAlign = 'right';

					bundleRow.appendChild(bundleNameCell);
					bundleRow.appendChild(bundlePriceCell);

					resultTableBody.appendChild(bundleRow);
				}

				if (ocrChecked) {
					const ocrRow = document.createElement('tr');

					const ocrNameCell = document.createElement('td');
					ocrNameCell.textContent = componentNames[5]; // OCR is at index 5

					const ocrPriceCell = document.createElement('td');
					ocrPriceCell.textContent = '€ ' + ocrCost.toFixed(2).replace('.', ',');
					ocrPriceCell.style.textAlign = 'right';

					ocrRow.appendChild(ocrNameCell);
					ocrRow.appendChild(ocrPriceCell);

					resultTableBody.appendChild(ocrRow);
				}

				const totalRow = document.createElement('tr');
				totalRow.className = 'totals';

				const totalNameCell = document.createElement('td');
				totalNameCell.textContent = 'Totaal';

				const totalPriceCell = document.createElement('td');
				totalPriceCell.textContent = '€ ' + total.toFixed(2).replace('.', ',');
				totalPriceCell.style.textAlign = 'right';

				totalRow.appendChild(totalNameCell);
				totalRow.appendChild(totalPriceCell);

				resultTableBody.appendChild(totalRow);

				if (bundle) {
					bundleInfo.innerHTML = '<br><br>Bundle: ' + bundle.code;
				}
			} else {
				resultSection.style.display = 'none';
			}
		}
		
		function initializeApp() {
			document.getElementById('bundle1').addEventListener('click', function () {
				document.getElementById('ism3Form').style.display = 'block';
				highlightActiveBundle('bundle1');
				fillForm(['a', 'c', 'd']);
				calculatePrices();
			});

			document.getElementById('bundle2').addEventListener('click', function () {
				document.getElementById('ism3Form').style.display = 'block';
				highlightActiveBundle('bundle2');
				fillForm(['b', 'd']);
				calculatePrices();
			});

			document.getElementById('bundle3').addEventListener('click', function () {
				document.getElementById('ism3Form').style.display = 'block';
				highlightActiveBundle('bundle3');
				fillForm(['a', 'c']);
				document.querySelector('input[name="ocr"]').checked = true;
				calculatePrices();
			});

			document.getElementById('customBundle').addEventListener('click', function () {
				document.getElementById('ism3Form').style.display = 'block';
				if (!document.getElementById('customBundle').classList.contains('active')) {
					document.querySelectorAll('input[name="boekhouding"]').forEach(radio => radio.checked = false);
					document.querySelectorAll('input[name="documenten"]').forEach(radio => radio.checked = false);
					document.querySelector('input[name="facturatie"]').checked = false;
					document.querySelector('input[name="ocr"]').checked = false;
					calculatePrices();
				}
				highlightActiveBundle('customBundle');
			});

			document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
				input.addEventListener('change', function () {
					const activePackageSelected = document.querySelector('.bundle-box.active:not(#customBundle)');
					if (activePackageSelected) {
						highlightActiveBundle('customBundle');
					}
					calculatePrices();
				});
			});
			
			if (window.parent && window.parent !== window) {
				window.parent.postMessage({
					type: 'loaded'
				}, '*');
			}
		}
		
		document.addEventListener('DOMContentLoaded', function() {
			processURLParameters();
		});
	</script>
</body>
</html>