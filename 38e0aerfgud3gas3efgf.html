<!DOCTYPE html>
<html lang="nl">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Upgrade</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.0/dist/themes/light.css">
	<script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.0/cdn/shoelace.js"></script>
	<style>
		body {
			font-family: sans-serif;
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
		}
		h1 {
			color: #333;
			margin-bottom: 20px;
		}
		h2 {
			color: #333;
			margin-bottom: 5px;
		}
		p {
			margin-top: 0;
			margin-bottom: 15px;
			color: #666;
		}
		.form-section {
			margin-bottom: 25px;
		}
		.form-section h2 {
			margin-bottom: 15px;
			font-size: 1rem;
			color: #444;
		}
		.form-section-header {
			margin-bottom: 15px;
			font-size: 1.2rem;
			color: #444;
		}
		.option-group {
			margin-bottom: 15px;
		}
		.option-group label {
			display: block;
			margin-bottom: 8px;
		}
		.result-table {
			width: 60%;
			border-collapse: collapse;
			margin-top: 30px;
		}
		.result-table th,
		.result-table td {
			border: 1px solid #ddd;
			padding: 8px;
			text-align: left;
		}
		.result-table th {
			background-color: #f2f2f2;
		}
		.result-section {
			margin-top: 40px;
			display: none;
		}
		.price {
			text-align: right;
		}
		.totals {
			font-weight: bold;
		}
		.subtotal {
			border-top: 2px solid #333;
		}
		.bundle-info {
			margin-top: 20px;
		}
		.bundles-container {
			display: flex;
			gap: 15px;
			margin-bottom: 30px;
			flex-wrap: wrap;
		}
		.bundle-box {
			border: 2px solid #ddd;
			border-radius: 8px;
			padding: 15px;
			width: 211px;
			cursor: pointer;
			transition: all 0.3s ease;
			background-color: #f9f9f9;
			display: flex;
			flex-direction: column;
			height: 144px;
		}
		.bundle-box:hover {
			border-color: #0077cc;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		}
		.bundle-box.active {
			border-color: #0077cc;
			background-color: #f0f7ff;
		}
		.bundle-box h3 {
			margin-top: 0;
			margin-bottom: 10px;
			color: #333;
			font-size: 1rem;
		}
		.bundle-box ul {
			margin: 0;
			padding-left: 20px;
			color: #555;
			flex-grow: 1;
			font-size: 0.9em;
		}
		.bundle-footer {
			margin-top: 10px;
			display: flex;
			flex-direction: column;
			align-items: flex-start;
		}
		.bundle-footer p {
			margin: 0;
			font-weight: bold;
			color: #0077cc;
		}
		@media (max-width: 768px) {
			.bundles-container {
				justify-content: center;
			}
			.result-table {
				width: 100%;
			}
		}
	</style>
</head>

<body>
	<h1 id="mainTitle">Upgrade</h1>
	<p id="mainSubtitle">Kies een reeds afgenomen pakket of stel zelf samen</p>

	<div class="bundles-container">
		<div class="bundle-box" id="bundle1">
			<h3>Pakket</h3>
			<ul id="bundle1Items">
				<li>Laden...</li>
			</ul>
			<div class="bundle-footer">
				<p id="bundle1Price">€ 0,00</p>
			</div>
		</div>

		<div class="bundle-box" id="bundle2">
			<h3>Pakket</h3>
			<ul id="bundle2Items">
				<li>Laden...</li>
			</ul>
			<div class="bundle-footer">
				<p id="bundle2Price">€ 0,00</p>
			</div>
		</div>

		<div class="bundle-box" id="bundle3">
			<h3>Pakket</h3>
			<ul id="bundle3Items">
				<li>Laden...</li>
			</ul>
			<div class="bundle-footer">
				<p id="bundle3Price">€ 0,00</p>
			</div>
		</div>

		<div class="bundle-box" id="customBundle">
			<h3>Zelf samenstellen</h3>
			<ul id="customBundleItems">
				<li>Kies je eigen combinatie</li>
			</ul>
			<div class="bundle-footer">
				<p>&nbsp;</p>
			</div>
		</div>
	</div>

	<div id="ism3Form" style="display: none;">
		<h2 class="form-section-header" style="margin-top: 10px; margin-bottom: 20px;">Upgradeformulier</h2>
		<div class="form-section">
			<h2>Klanttoegang tot Boekhouding</h2>
			<div class="option-group">
				<label>
					<input type="radio" name="boekhouding" value="geen"> Nee, graag geen enkele toegang tot Financieel
				</label>
				<label>
					<input type="radio" name="boekhouding" value="financieel"> Financieel
				</label>
				<label>
					<input type="radio" name="boekhouding" value="financieel-meekijken"> Financieel alleen Meekijken
				</label>
			</div>
		</div>

		<div class="form-section">
			<h2>Verkoopfacturen</h2>
			<div class="option-group">
				<label>
					<input type="checkbox" name="facturatie"> Facturatie
				</label>
			</div>
		</div>

		<div class="form-section">
			<h2>Documenten</h2>
			<div class="option-group">
				<label>
					<input type="radio" name="documenten" value="nvt"> Geen AdmInbox
				</label>
				<label>
					<input type="radio" name="documenten" value="adminbox-scanuser"> AdmInbox (Alleen Aanleveren)
				</label>
				<label>
					<input type="radio" name="documenten" value="adminbox"> AdmInbox (Aanleveren & Registreren)
				</label>
			</div>
		</div>

		<div class="form-section">
			<h2>Facturen en bonnetjes herkennen</h2>
			<div class="option-group">
				<label>
					<input type="checkbox" name="ocr"> OCR
				</label>
			</div>
		</div>
	</div>

	<div id="resultSection" class="result-section">
		<h2 class="form-section-header">Kostenoverzicht</h2>
		<table id="resultTable" class="result-table">
			<thead>
				<tr>
					<th>Omschrijving</th>
					<th style="text-align: right;">Bedrag</th>
				</tr>
			</thead>
			<tbody id="resultTableBody">
			</tbody>
		</table>
		<div id="bundleInfo" class="bundle-info"></div>
	</div>

	<script>
		// Globale variabelen
		let prices = [];              // Prijzen van componenten
		let bundles = [];             // Bundel data
		let componentNames = [];      // Namen van componenten
		let componentMap = {};        // Mapping van indices naar letters
		let uiBundles = [];           // Bundels voor UI display

		// Functie om URL parameters te verwerken
		function processURLParameters() {
			const urlParams = new URLSearchParams(window.location.search);
			
			// Basis parameters
			const title = urlParams.get('title');
			if (title) {
				document.getElementById('mainTitle').textContent = title;
				document.title = title;
			}
			
			const subtitle = urlParams.get('subtitle');
			if (subtitle) {
				document.getElementById('mainSubtitle').textContent = subtitle;
			}
			
			// Componenten en prijzen
			if (urlParams.has('ps')) {
				try {
					prices = JSON.parse(decodeURIComponent(urlParams.get('ps')));
				} catch (e) {
					console.error('Error parsing prices:', e);
				}
			}
			
			if (urlParams.has('cn')) {
				try {
					componentNames = JSON.parse(decodeURIComponent(urlParams.get('cn')));
				} catch (e) {
					console.error('Error parsing component names:', e);
				}
			}
			
			// Bundeldata
			if (urlParams.has('bs')) {
				try {
					const bundlesData = JSON.parse(decodeURIComponent(urlParams.get('bs')));
					bundles = bundlesData.map(b => ({
						components: b.c.map(index => indexToLetter(index)),
						code: b.n,
						discount: b.d,
						originalCode: urlParams.has('codecustom') ? urlParams.get('codecustom') + ' ' + b.n : 'ISM3 ' + b.n
					}));
				} catch (e) {
					console.error('Error parsing bundles:', e);
				}
			}
			
			// UI bundels
			if (urlParams.has('ui')) {
				try {
					uiBundles = JSON.parse(decodeURIComponent(urlParams.get('ui')));
				} catch (e) {
					console.error('Error parsing UI bundles:', e);
				}
			}
			
			// Component mapping
			setupComponentMap();
			
			// UI opzetten
			setupUI();
			
			// Initialiseren
			initializeApp();
		}
		
		// Componenten mapping opzetten
		function setupComponentMap() {
			componentMap = {
				0: 'a', // Financieel
				1: 'b', // AdmInbox
				2: 'c', // AdmInbox Scanuser
				3: 'd', // Facturatie
				4: 'e', // Financieel Meekijken
				5: 'f'  // Onbeperkt OCR
			};
		}
		
		// Letter naar index functie
		function letterToIndex(letter) {
			for (const [index, value] of Object.entries(componentMap)) {
				if (value === letter) {
					return parseInt(index);
				}
			}
			return -1;
		}
		
		// Index naar letter functie
		function indexToLetter(index) {
			return componentMap[index];
		}
		
		// UI instellen met bundels
		function setupUI() {
			if (uiBundles.length >= 4) {
				setupBundleUI('bundle1', uiBundles[0]);
				setupBundleUI('bundle2', uiBundles[1]);
				setupBundleUI('bundle3', uiBundles[2]);
				setupBundleUI('customBundle', uiBundles[3]);
			}
		}
		
		// Setup individuele bundel UI
		function setupBundleUI(bundleId, data) {
			if (!data) return;
			
			const itemsElement = document.getElementById(bundleId + 'Items');
			const priceElement = document.getElementById(bundleId + 'Price');
			
			// Bewaar bundel code voor later
			if (bundleId !== 'customBundle' && data.c) {
				document.getElementById(bundleId).dataset.bundleCode = data.c;
			}
			
			if (itemsElement && data.i && data.i.length > 0) {
				itemsElement.innerHTML = '';
				
				const items = data.i;
				
				items.forEach(item => {
					const li = document.createElement('li');
					if (typeof item === 'string' && item.includes('(')) {
						// Line break na opening haakje
						li.innerHTML = item.replace(/\(/g, '(<br>');
					} else {
						li.textContent = item;
					}
					itemsElement.appendChild(li);
				});
			}
			
			if (priceElement && data.p) {
				priceElement.textContent = data.p;
			}
		}
		
		// Bundel opzoeken op basis van code
		function findBundleByCode(code) {
			return bundles.find(b => b.code === code);
		}
		
		// Formulier invullen op basis van geselecteerde componenten
		function fillForm(components) {
			// Reset formulier
			document.querySelector('input[name="boekhouding"][value="geen"]').checked = true;
			document.querySelector('input[name="facturatie"]').checked = false;
			document.querySelector('input[name="documenten"][value="nvt"]').checked = true;
			document.querySelector('input[name="ocr"]').checked = false;

			// Zet juiste waarden
			if (components.includes('a')) {
				document.querySelector('input[name="boekhouding"][value="financieel"]').checked = true;
			} else if (components.includes('e')) {
				document.querySelector('input[name="boekhouding"][value="financieel-meekijken"]').checked = true;
			}

			if (components.includes('d')) {
				document.querySelector('input[name="facturatie"]').checked = true;
			}

			if (components.includes('b')) {
				document.querySelector('input[name="documenten"][value="adminbox"]').checked = true;
			} else if (components.includes('c')) {
				document.querySelector('input[name="documenten"][value="adminbox-scanuser"]').checked = true;
			}

			if (components.includes('f')) {
				document.querySelector('input[name="ocr"]').checked = true;
			}
		}
		
		// Actieve bundel markeren
		function highlightActiveBundle(bundleId) {
			document.querySelectorAll('.bundle-box').forEach(box => {
				box.classList.remove('active');
			});
			document.getElementById(bundleId).classList.add('active');
		}
		
		// Geselecteerde componenten ophalen uit formulier
		function getSelectedComponents() {
			const boekhoudingChecked = document.querySelector('input[name="boekhouding"]:checked');
			const documentenChecked = document.querySelector('input[name="documenten"]:checked');

			const boekhouding = boekhoudingChecked ? boekhoudingChecked.value : '';
			const facturatie = document.querySelector('input[name="facturatie"]').checked;
			const documenten = documentenChecked ? documentenChecked.value : '';
			const ocrChecked = document.querySelector('input[name="ocr"]').checked;

			const selectedComponents = [];

			// Boekhouding
			if (boekhouding === 'financieel') {
				selectedComponents.push('a');  // Financieel
			} else if (boekhouding === 'financieel-meekijken') {
				selectedComponents.push('e');  // Financieel Meekijken
			}

			// Facturatie
			if (facturatie) {
				selectedComponents.push('d');  // Facturatie
			}

			// Documenten
			if (documenten === 'adminbox') {
				selectedComponents.push('b');  // AdminBox
			} else if (documenten === 'adminbox-scanuser') {
				selectedComponents.push('c');  // AdminBox Scanuser
			}

			return {
				selectedComponents,
				ocrChecked
			};
		}
		
		// Bundel highlighten op basis van geselecteerde componenten
		function updateBundleHighlighting(components) {
			// Alleen updaten als custom niet actief is
			if (!document.getElementById('customBundle').classList.contains('active')) {
				const sortedComponents = [...components].sort();
				const selectedStr = JSON.stringify(sortedComponents);

				// Zoek in alle 3 bundels
				let found = false;
				
				for (let i = 1; i <= 3; i++) {
					const bundleElement = document.getElementById(`bundle${i}`);
					const bundleCode = bundleElement.dataset.bundleCode;
					
					if (bundleCode) {
						const bundle = findBundleByCode(bundleCode);
						if (bundle) {
							const sortedBundleComponents = [...bundle.components].sort();
							if (JSON.stringify(sortedBundleComponents) === selectedStr) {
								highlightActiveBundle(`bundle${i}`);
								found = true;
								break;
							}
						}
					}
				}
				
				// Als geen match gevonden, markeer als custom
				if (!found) {
					highlightActiveBundle('customBundle');
				}
			}
		}
		
		// Prijzen berekenen
		function calculatePrices() {
			const { selectedComponents, ocrChecked } = getSelectedComponents();
			
			// Sorteer voor consistente vergelijking
			const sortedComponents = [...selectedComponents].sort();

			// Zoek bijpassende bundel
			let bundleMatch = null;
			for (const bundle of bundles) {
				const sortedBundleComponents = [...bundle.components].sort();
				if (JSON.stringify(sortedComponents) === JSON.stringify(sortedBundleComponents)) {
					bundleMatch = bundle;
					break;
				}
			}

			// Bereken componenten som
			let subtotal = 0;
			const componentPrices = [];
			
			for (const component of selectedComponents) {
				const componentIndex = letterToIndex(component);
				if (componentIndex !== -1) {
					const price = prices[componentIndex];
					subtotal += price;
					componentPrices.push({
						name: componentNames[componentIndex],
						price: price
					});
				}
			}

			// Bundel korting
			const discount = bundleMatch ? bundleMatch.discount : 0;
			const bundleTotal = subtotal - discount;

			// OCR prijs
			const ocrCost = ocrChecked ? prices[5] : 0; // OCR is index 5
			const totalPrice = bundleTotal + ocrCost;

			// Toon resultaten
			displayResults(
				componentPrices,
				subtotal,
				discount,
				bundleTotal,
				ocrChecked,
				ocrCost,
				totalPrice,
				bundleMatch
			);

			// Update bundel highlighting
			updateBundleHighlighting(selectedComponents);
			
			// Stuur data naar parent indien in iframe
			sendDataToParent(selectedComponents, totalPrice, bundleMatch);
		}
		
		// Stuur data naar parent frame
		function sendDataToParent(components, total, bundle) {
			if (window.parent && window.parent !== window) {
				const selectedData = {
					components: components,
					total: total,
					bundleCode: bundle ? bundle.code : null
				};
				
				try {
					window.parent.postMessage({
						type: 'selection',
						data: selectedData
					}, '*');
				} catch (e) {
					console.error('Fout bij verzenden data naar parent:', e);
				}
			}
		}

		// Toon resultaten in kostenoverzicht
		function displayResults(componentPrices, subtotal, discount, bundleTotal, ocrChecked, ocrCost, totalPrice, bundle) {
			const resultSection = document.getElementById('resultSection');
			const resultTableBody = document.getElementById('resultTableBody');
			const bundleInfo = document.getElementById('bundleInfo');

			resultTableBody.innerHTML = '';
			bundleInfo.innerHTML = '';

			if ((componentPrices.length > 0 || ocrChecked) && totalPrice > 0) {
				resultSection.style.display = 'block';

				// Individuele componenten tonen
				componentPrices.forEach(component => {
					const row = document.createElement('tr');
					
					const nameCell = document.createElement('td');
					nameCell.textContent = component.name;
					
					const priceCell = document.createElement('td');
					priceCell.textContent = '€ ' + component.price.toFixed(2).replace('.', ',');
					priceCell.style.textAlign = 'right';
					
					row.appendChild(nameCell);
					row.appendChild(priceCell);
					
					resultTableBody.appendChild(row);
				});
				
				// Subtotaal regel
				if (componentPrices.length > 1) {
					const subtotalRow = document.createElement('tr');
					subtotalRow.className = 'subtotal';
					
					const subtotalNameCell = document.createElement('td');
					subtotalNameCell.textContent = 'Subtotaal';
					
					const subtotalPriceCell = document.createElement('td');
					subtotalPriceCell.textContent = '€ ' + subtotal.toFixed(2).replace('.', ',');
					subtotalPriceCell.style.textAlign = 'right';
					
					subtotalRow.appendChild(subtotalNameCell);
					subtotalRow.appendChild(subtotalPriceCell);
					
					resultTableBody.appendChild(subtotalRow);
				}
				
				// Bundelkorting tonen indien van toepassing
				if (discount > 0) {
					const discountRow = document.createElement('tr');
					
					const discountNameCell = document.createElement('td');
					discountNameCell.textContent = 'Bundelkorting';
					
					const discountPriceCell = document.createElement('td');
					discountPriceCell.textContent = '€ -' + discount.toFixed(2).replace('.', ',');
					discountPriceCell.style.textAlign = 'right';
					
					discountRow.appendChild(discountNameCell);
					discountRow.appendChild(discountPriceCell);
					
					resultTableBody.appendChild(discountRow);
				}
				
				// OCR toevoegen indien geselecteerd
				if (ocrChecked) {
					const ocrRow = document.createElement('tr');
					
					const ocrNameCell = document.createElement('td');
					ocrNameCell.textContent = componentNames[5]; // OCR naam
					
					const ocrPriceCell = document.createElement('td');
					ocrPriceCell.textContent = '€ ' + ocrCost.toFixed(2).replace('.', ',');
					ocrPriceCell.style.textAlign = 'right';
					
					ocrRow.appendChild(ocrNameCell);
					ocrRow.appendChild(ocrPriceCell);
					
					resultTableBody.appendChild(ocrRow);
				}
				
				// Totaal tonen
				const totalRow = document.createElement('tr');
				totalRow.className = 'totals';
				
				const totalNameCell = document.createElement('td');
				totalNameCell.textContent = 'Totaal';
				
				const totalPriceCell = document.createElement('td');
				totalPriceCell.textContent = '€ ' + totalPrice.toFixed(2).replace('.', ',');
				totalPriceCell.style.textAlign = 'right';
				
				totalRow.appendChild(totalNameCell);
				totalRow.appendChild(totalPriceCell);
				
				resultTableBody.appendChild(totalRow);

				// Bundel code tonen indien van toepassing
				if (bundle) {
					bundleInfo.innerHTML = `<br>Bundle artikelnummer: ${bundle.originalCode || ('ISM3 ' + bundle.code)}`;
				}
			} else {
				resultSection.style.display = 'none';
			}
		}
		
		// App initialiseren
		function initializeApp() {
			// Toon formulier
			document.getElementById('ism3Form').style.display = 'block';
			
			// Bundle 1 onclick
			document.getElementById('bundle1').addEventListener('click', function() {
				highlightActiveBundle('bundle1');
				
				const bundleCode = this.dataset.bundleCode;
				const bundle = findBundleByCode(bundleCode);
				
				if (bundle) {
					fillForm(bundle.components);
					calculatePrices();
				}
			});
			
			// Bundle 2 onclick
			document.getElementById('bundle2').addEventListener('click', function() {
				highlightActiveBundle('bundle2');
				
				const bundleCode = this.dataset.bundleCode;
				const bundle = findBundleByCode(bundleCode);
				
				if (bundle) {
					fillForm(bundle.components);
					calculatePrices();
				}
			});
			
			// Bundle 3 onclick
			document.getElementById('bundle3').addEventListener('click', function() {
				highlightActiveBundle('bundle3');
				
				const bundleCode = this.dataset.bundleCode;
				const bundle = findBundleByCode(bundleCode);
				
				if (bundle) {
					fillForm(bundle.components);
					calculatePrices();
				}
			});
			
			// Custom bundle onclick
			document.getElementById('customBundle').addEventListener('click', function() {
				highlightActiveBundle('customBundle');
				
				// Reset formulier
				document.querySelectorAll('input[name="boekhouding"]').forEach(radio => radio.checked = false);
				document.querySelectorAll('input[name="documenten"]').forEach(radio => radio.checked = false);
				document.querySelector('input[name="facturatie"]').checked = false;
				document.querySelector('input[name="ocr"]').checked = false;
				
				calculatePrices();
			});
			
			// Update prijzen bij form wijzigingen
			document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
				input.addEventListener('change', function() {
					const activePackageSelected = document.querySelector('.bundle-box.active:not(#customBundle)');
					if (activePackageSelected) {
						highlightActiveBundle('customBundle');
					}
					calculatePrices();
				});
			});
			
			// Loaded event sturen indien in iframe
			if (window.parent && window.parent !== window) {
				window.parent.postMessage({
					type: 'loaded'
				}, '*');
			}
		}
		
		// Start verwerking bij laden pagina
		document.addEventListener('DOMContentLoaded', function() {
			processURLParameters();
		});
	</script>
</body>
</html>