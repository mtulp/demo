<!DOCTYPE html>
<html lang="nl">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Upgrade</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.0/dist/themes/light.css">
	<script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.0/cdn/shoelace.js"></script>
	<style>
		body {
			font-family: sans-serif;
			max-width: 800px;
			margin: 0 auto;
			padding: 20px;
		}

		h1 {
			color: #333;
			margin-bottom: 20px;
		}

		h2 {
			color: #333;
			margin-bottom: 5px;
		}

		p {
			margin-top: 0;
			margin-bottom: 15px;
			color: #666;
		}

		.form-section {
			margin-bottom: 25px;
		}

		.form-section h2 {
			margin-bottom: 15px;
			font-size: 1rem;
			color: #444;
		}

		.form-section-header {
			margin-bottom: 15px;
			font-size: 1.2rem;
			color: #444;
		}

		.option-group {
			margin-bottom: 15px;
		}

		.option-group label {
			display: block;
			margin-bottom: 8px;
		}

		.result-table {
			width: 60%;
			border-collapse: collapse;
			margin-top: 30px;
		}

		.result-table th,
		.result-table td {
			border: 1px solid #ddd;
			padding: 8px;
			text-align: left;
		}

		.result-table th {
			background-color: #f2f2f2;
		}

		.result-section {
			margin-top: 40px;
			display: none;
		}

		.price {
			text-align: right;
		}

		.totals {
			font-weight: bold;
		}

		.subtotal {
			border-top: 2px solid #333;
		}

		.bundle-info {
			margin-top: 20px;
		}


		.bundles-container {
			display: flex;
			gap: 15px;
			margin-bottom: 30px;
			flex-wrap: wrap;
		}

		.bundle-box {
			border: 2px solid #ddd;
			border-radius: 8px;
			padding: 15px;
			width: 180px;
			cursor: pointer;
			transition: all 0.3s ease;
			background-color: #f9f9f9;
			display: flex;
			flex-direction: column;
		}

		.bundle-box:hover {
			border-color: #0077cc;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		}

		.bundle-box h3 {
			margin-top: 0;
			margin-bottom: 10px;
			color: #333;
			font-size: 1rem;
		}

		.bundle-box ul {
			margin: 0;
			padding-left: 20px;
			color: #555;
			flex-grow: 1;
			font-size: 0.9em;
		}

		.bundle-footer {
			margin-top: 10px;
			display: flex;
			flex-direction: column;
			align-items: flex-start;
		}

		.bundle-footer p {
			margin: 0;
			font-weight: bold;
			color: #0077cc;
		}

		.bundle-count {
			font-size: 0.9em;
			color: #666;
		}

		.bundle-box.active {
			border-color: #0077cc;
			background-color: #e6f3ff;
		}


		@media (max-width: 768px) {
			.bundles-container {
				justify-content: center;
			}
			
			.result-table {
				width: 100%;
			}
		}
	</style>
</head>

<body>
	<h1 id="mainTitle">Upgrade</h1>

	<p id="mainSubtitle">Kies een reeds afgenomen pakket of stel zelf samen</p>

	<div class="bundles-container">
		<div class="bundle-box" id="bundle1">
			<h3>Pakket</h3>
			<ul>
				<li>Financieel</li>
				<li>Facturatie</li>
				<li>AdmInbox</li>
			</ul>
			<div class="bundle-footer">
				<p>€ 30,44</p>
				<span class="bundle-count">Administraties: 22</span>
			</div>
		</div>

		<div class="bundle-box" id="bundle2">
			<h3>Pakket</h3>
			<ul>
				<li>Financieel Meekijken</li>
				<li>AdmInbox</li>
			</ul>
			<div class="bundle-footer">
				<p>€ 21,31</p>
				<span class="bundle-count">Administraties: 9</span>
			</div>
		</div>

		<div class="bundle-box" id="bundle3">
			<h3>Pakket</h3>
			<ul>
				<li>Financieel</li>
				<li>Facturatie</li>
			</ul>
			<div class="bundle-footer">
				<p>€ 30,42</p>
				<span class="bundle-count">Administraties: 14</span>
			</div>
		</div>

		<div class="bundle-box" id="customBundle">
			<h3>Zelf samenstellen</h3>
			<ul>
				<li>Kies je eigen combinatie</li>
			</ul>
			<div class="bundle-footer">
				<p>&nbsp;</p>
				<span class="bundle-count">&nbsp;</span>
			</div>
		</div>
	</div>

	<div id="ism3Form" style="display: none;">
		<h2 class="form-section-header" style="margin-top: 10px; margin-bottom: 20px;">Upgradeformulier</h2>
		<div class="form-section">
			<h2>Klanttoegang tot Boekhouding</h2>
			<div class="option-group">
				<label>
					<input type="radio" name="boekhouding" value="geen"> Nee, graag geen enkele toegang tot Financieel
				</label>
				<label>
					<input type="radio" name="boekhouding" value="financieel"> Financieel
				</label>
				<label>
					<input type="radio" name="boekhouding" value="financieel-meekijken"> Financieel alleen Meekijken
				</label>
			</div>
		</div>

		<div class="form-section">
			<h2>Verkoopfacturen</h2>
			<div class="option-group">
				<label>
					<input type="checkbox" name="facturatie"> Facturatie
				</label>
			</div>
		</div>

		<div class="form-section">
			<h2>Documenten</h2>
			<div class="option-group">
				<label>
					<input type="radio" name="documenten" value="nvt"> Geen AdmInbox
				</label>
				<label>
					<input type="radio" name="documenten" value="adminbox-scanuser"> AdmInbox (Alleen Aanleveren)
				</label>
				<label>
					<input type="radio" name="documenten" value="adminbox"> AdmInbox (Aanleveren & Registreren)
				</label>
			</div>
		</div>

		<div class="form-section">
			<h2>Facturen en bonnetjes herkennen</h2>
			<div class="option-group">
				<label>
					<input type="checkbox" name="ocr"> OCR
				</label>
			</div>
		</div>
	</div>

	<div id="resultSection" class="result-section">
		<h2 class="form-section-header">Kostenoverzicht</h2>
		<table id="resultTable" class="result-table">
			<thead>
				<tr>
					<th>Omschrijving</th>
					<th style="text-align: right;">Bedrag</th>
				</tr>
			</thead>
			<tbody id="resultTableBody">
			</tbody>
		</table>
		<div id="bundleInfo" class="bundle-info"></div>
	</div>

	<script>
		let prices = {
			financieel: 15.21,
			financieel_meekijken: 9.14,
			facturatie: 15.21,
			adminbox: 15.21,
			adminbox_scanuser: 9.14,
			ocr: 3.06
		};

		let bundles = [
			{
				components: ["financieel", "facturatie"],
				discount: 0.00,
				code: "Upgrade FF"
			},
			{
				components: ["financieel", "facturatie", "adminbox"],
				discount: 15.19,
				code: "Upgrade ADM FI FA"
			},
			{
				components: ["financieel_meekijken", "adminbox"],
				discount: 3.04,
				code: "Upgrade ADM FI ME"
			},
			{
				components: ["financieel_meekijken", "adminbox_scanuser"],
				discount: 0.00,
				code: "Upgrade ADM SU FI ME"
			},
			{
				components: ["financieel_meekijken", "facturatie"],
				discount: 0.00,
				code: "Upgrade MK+ FACT"
			},
			{
				components: ["financieel_meekijken", "facturatie", "adminbox"],
				discount: 0.00,
				code: "Upgrade MK+_FACT_ADM"
			},
			{
				components: ["facturatie", "adminbox"],
				discount: 0.00,
				code: "Upgrade ADM FA"
			},
			{
				components: ["facturatie", "adminbox_scanuser"],
				discount: 0.00,
				code: "Upgrade FACT SU_2"
			}
		];

		let componentNames = {
			financieel: "Financieel",
			financieel_meekijken: "Financieel Meekijken",
			facturatie: "Facturatie",
			adminbox: "AdmInbox (Aanleveren & Registreren)",
			adminbox_scanuser: "AdmInbox (Alleen Aanleveren)",
			ocr: "OCR"
		};
		function fillForm(components) {
			document.querySelector('input[name="boekhouding"][value="geen"]').checked = true;
			document.querySelector('input[name="facturatie"]').checked = false;
			document.querySelector('input[name="documenten"][value="nvt"]').checked = true;
			document.querySelector('input[name="ocr"]').checked = false;

			if (components.includes('financieel')) {
				document.querySelector('input[name="boekhouding"][value="financieel"]').checked = true;
			} else if (components.includes('financieel_meekijken')) {
				document.querySelector('input[name="boekhouding"][value="financieel-meekijken"]').checked = true;
			}

			if (components.includes('facturatie')) {
				document.querySelector('input[name="facturatie"]').checked = true;
			}

			if (components.includes('adminbox')) {
				document.querySelector('input[name="documenten"][value="adminbox"]').checked = true;
			} else if (components.includes('adminbox_scanuser')) {
				document.querySelector('input[name="documenten"][value="adminbox-scanuser"]').checked = true;
			}
		}


		function highlightActiveBundle(bundleId) {
			document.querySelectorAll('.bundle-box').forEach(box => {
				box.classList.remove('active');
			});
			document.getElementById(bundleId).classList.add('active');
		}


		function getSelectedComponents() {

			const boekhoudingChecked = document.querySelector('input[name="boekhouding"]:checked');
			const documentenChecked = document.querySelector('input[name="documenten"]:checked');


			const boekhouding = boekhoudingChecked ? boekhoudingChecked.value : '';
			const facturatie = document.querySelector('input[name="facturatie"]').checked;
			const documenten = documentenChecked ? documentenChecked.value : '';
			const ocrChecked = document.querySelector('input[name="ocr"]').checked;

			const selectedComponents = [];

			if (boekhouding === 'financieel') {
				selectedComponents.push('financieel');
			} else if (boekhouding === 'financieel-meekijken') {
				selectedComponents.push('financieel_meekijken');
			}

			if (facturatie) {
				selectedComponents.push('facturatie');
			}

			if (documenten === 'adminbox') {
				selectedComponents.push('adminbox');
			} else if (documenten === 'adminbox-scanuser') {
				selectedComponents.push('adminbox_scanuser');
			}

			return {
				selectedComponents,
				ocrChecked
			};
		}


		function updateBundleHighlighting(components) {

			if (!document.getElementById('customBundle').classList.contains('active')) {
				const sortedComponents = [...components].sort();
				const selectedStr = JSON.stringify(sortedComponents);

				if (JSON.stringify(["financieel", "facturatie", "adminbox"].sort()) === selectedStr) {
					highlightActiveBundle('bundle1');
				} else if (JSON.stringify(["financieel_meekijken", "adminbox"].sort()) === selectedStr) {
					highlightActiveBundle('bundle2');
				} else if (JSON.stringify(["financieel", "facturatie"].sort()) === selectedStr) {
					highlightActiveBundle('bundle3');
				} else {
					highlightActiveBundle('customBundle');
				}
			}

		}


		function calculatePrices() {
			const { selectedComponents, ocrChecked } = getSelectedComponents();
			const sortedComponents = [...selectedComponents].sort();


			let bundleMatch = null;
			for (const bundle of bundles) {
				const sortedBundleComponents = [...bundle.components].sort();
				if (JSON.stringify(sortedComponents) === JSON.stringify(sortedBundleComponents)) {
					bundleMatch = bundle;
					break;
				}
			}


			let subtotal = 0;
			for (const component of selectedComponents) {
				subtotal += prices[component];
			}

			const discount = bundleMatch ? bundleMatch.discount : 0;
			const bundleTotal = subtotal - discount;


			const ocrCost = ocrChecked ? prices.ocr : 0;


			const total = bundleTotal + ocrCost;


			displayResults(selectedComponents, subtotal, discount, bundleTotal, ocrChecked, ocrCost, total, bundleMatch);


			updateBundleHighlighting(selectedComponents);
            

            sendDataToParent(selectedComponents, total, bundleMatch);
		}
        

        function sendDataToParent(components, total, bundle) {
            if (window.parent && window.parent !== window) {
                const selectedData = {
                    components: components,
                    total: total,
                    bundleCode: bundle ? bundle.code : null
                };
                
                try {
                    window.parent.postMessage({
                        type: 'selection',
                        data: selectedData
                    }, '*');
                } catch (e) {
                    console.error('Fout bij verzenden data naar parent:', e);
                }
            }
        }


		function displayResults(components, subtotal, discount, bundleTotal, ocrChecked, ocrCost, total, bundle) {
			const resultSection = document.getElementById('resultSection');
			const resultTableBody = document.getElementById('resultTableBody');
			const bundleInfo = document.getElementById('bundleInfo');

			resultTableBody.innerHTML = '';
			bundleInfo.innerHTML = '';


			if ((components.length > 0 || ocrChecked) && total > 0) {
				resultSection.style.display = 'block';


				for (const component of components) {
					const row = document.createElement('tr');

					const nameCell = document.createElement('td');
					nameCell.textContent = componentNames[component];

					const priceCell = document.createElement('td');
					priceCell.textContent = '€ ' + prices[component].toFixed(2).replace('.', ',');
					priceCell.style.textAlign = 'right';

					row.appendChild(nameCell);
					row.appendChild(priceCell);

					resultTableBody.appendChild(row);
				}


				if (discount > 0) {
					// Korting rij
					const discountRow = document.createElement('tr');

					const discountNameCell = document.createElement('td');
					discountNameCell.textContent = 'Bundelkorting';

					const discountPriceCell = document.createElement('td');
					discountPriceCell.textContent = '€ -' + discount.toFixed(2).replace('.', ',');
					discountPriceCell.style.textAlign = 'right';

					discountRow.appendChild(discountNameCell);
					discountRow.appendChild(discountPriceCell);

					resultTableBody.appendChild(discountRow);
				}


				if (bundleTotal !== total || ocrChecked) {
					const bundleRow = document.createElement('tr');
					bundleRow.className = 'subtotal';

					const bundleNameCell = document.createElement('td');
					bundleNameCell.textContent = 'Bundle';

					const bundlePriceCell = document.createElement('td');
					bundlePriceCell.textContent = '€ ' + bundleTotal.toFixed(2).replace('.', ',');
					bundlePriceCell.style.textAlign = 'right';

					bundleRow.appendChild(bundleNameCell);
					bundleRow.appendChild(bundlePriceCell);

					resultTableBody.appendChild(bundleRow);
				}


				if (ocrChecked) {
					const ocrRow = document.createElement('tr');

					const ocrNameCell = document.createElement('td');
					ocrNameCell.textContent = 'OCR';

					const ocrPriceCell = document.createElement('td');
					ocrPriceCell.textContent = '€ ' + ocrCost.toFixed(2).replace('.', ',');
					ocrPriceCell.style.textAlign = 'right';

					ocrRow.appendChild(ocrNameCell);
					ocrRow.appendChild(ocrPriceCell);

					resultTableBody.appendChild(ocrRow);
				}


				const totalRow = document.createElement('tr');
				totalRow.className = 'totals';

				const totalNameCell = document.createElement('td');
				totalNameCell.textContent = 'Totaal';

				const totalPriceCell = document.createElement('td');
				totalPriceCell.textContent = '€ ' + total.toFixed(2).replace('.', ',');
				totalPriceCell.style.textAlign = 'right';

				totalRow.appendChild(totalNameCell);
				totalRow.appendChild(totalPriceCell);

				resultTableBody.appendChild(totalRow);


				if (bundle) {
					bundleInfo.innerHTML = '<br><br>Bundle: ' + bundle.code;
				}
			} else {
				resultSection.style.display = 'none';
			}
		}

		function processURLParameters() {
			const urlParams = new URLSearchParams(window.location.search);
			
			if (urlParams.has('title')) {
				document.getElementById('mainTitle').textContent = urlParams.get('title');
				document.title = urlParams.get('title');
			}
			
			if (urlParams.has('subtitle')) {
				document.getElementById('mainSubtitle').textContent = urlParams.get('subtitle');
			}
			
			if (urlParams.has('removeAdminCounts') && urlParams.get('removeAdminCounts') === 'true') {
				document.querySelectorAll('.bundle-count').forEach(element => {
					element.style.display = 'none';
				});
			}
			
			// Verwerk prijsinformatie
			if (urlParams.has('prices')) {
				try {
					prices = JSON.parse(decodeURIComponent(urlParams.get('prices')));
				} catch (e) {
					console.error('Fout bij het verwerken van prijsinformatie:', e);
				}
			}
			
			// Verwerk bundelsinformatie
			if (urlParams.has('bundles')) {
				try {
					bundles = JSON.parse(decodeURIComponent(urlParams.get('bundles')));
				} catch (e) {
					console.error('Fout bij het verwerken van bundelsinformatie:', e);
				}
			}
			
			// Verwerk componentnamen
			if (urlParams.has('componentNames')) {
				try {
					componentNames = JSON.parse(decodeURIComponent(urlParams.get('componentNames')));
				} catch (e) {
					console.error('Fout bij het verwerken van componentnamen:', e);
				}
			}
			
			// Verwerk bundel UI informatie
			if (urlParams.has('bundleUI')) {
				try {
					const bundleUIData = JSON.parse(decodeURIComponent(urlParams.get('bundleUI')));
					updateBundleUI(bundleUIData);
				} catch (e) {
					console.error('Fout bij het verwerken van bundle UI informatie:', e);
				}
			}
		}
		
		function updateBundleUI(bundleUIData) {
			// Update bundleboxes met data uit URL parameters
			document.querySelectorAll('.bundle-box').forEach((box, index) => {
				if (bundleUIData[index]) {
					const data = bundleUIData[index];
					const boxData = box.querySelector('ul');
					const price = box.querySelector('.bundle-footer p');
					const count = box.querySelector('.bundle-count');
					
					// Update items
					if (data.items && data.items.length > 0) {
						boxData.innerHTML = '';
						data.items.forEach(item => {
							const li = document.createElement('li');
							li.textContent = item;
							boxData.appendChild(li);
						});
					}
					
					// Update price
					if (data.price) {
						price.textContent = data.price;
					}
					
					// Update count
					if (data.count) {
						count.textContent = data.count;
					}
				}
			});
		}


		document.addEventListener('DOMContentLoaded', function () {

			processURLParameters();
			

			document.getElementById('bundle1').addEventListener('click', function () {
				document.getElementById('ism3Form').style.display = 'block';
				highlightActiveBundle('bundle1');
				fillForm(["financieel", "facturatie", "adminbox"]);
				calculatePrices();
			});

			document.getElementById('bundle2').addEventListener('click', function () {
				document.getElementById('ism3Form').style.display = 'block';
				highlightActiveBundle('bundle2');
				fillForm(["financieel_meekijken", "adminbox"]);
				calculatePrices();
			});

			document.getElementById('bundle3').addEventListener('click', function () {
				document.getElementById('ism3Form').style.display = 'block';
				highlightActiveBundle('bundle3');
				fillForm(["financieel", "facturatie"]);

				document.querySelector('input[name="ocr"]').checked = true;
				calculatePrices();
			});

			document.getElementById('customBundle').addEventListener('click', function () {
				document.getElementById('ism3Form').style.display = 'block';

				if (!document.getElementById('customBundle').classList.contains('active')) {

					document.querySelectorAll('input[name="boekhouding"]').forEach(radio => radio.checked = false);
					document.querySelectorAll('input[name="documenten"]').forEach(radio => radio.checked = false);
					document.querySelector('input[name="facturatie"]').checked = false;
					document.querySelector('input[name="ocr"]').checked = false;
					calculatePrices();
				}
				highlightActiveBundle('customBundle');
			});


			document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
				input.addEventListener('change', function () {

					const activePackageSelected = document.querySelector('.bundle-box.active:not(#customBundle)');
					if (activePackageSelected) {

						highlightActiveBundle('customBundle');
					}
					calculatePrices();
				});
			});
            

            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'loaded'
                }, '*');
            }
		});
	</script>
</body>

</html>